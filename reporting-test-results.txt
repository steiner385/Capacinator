
> capacinator@1.0.0 test
> jest --config jest.config.cjs ReportingController.test.ts --coverage --watchAll=false

  console.log
    [dotenv@17.1.0] injecting env (19) from .env.test (tip: ⚙️  specify custom .env file path with { path: '/custom/path/.env' })

      at _log (node_modules/dotenv/lib/main.js:129:11)

FAIL server-unit src/server/api/controllers/__tests__/ReportingController.test.ts
  ReportingController
    getDashboard - Get Dashboard Data
      ✕ retrieves dashboard with all components (8 ms)
      ✕ categorizes project health correctly (1 ms)
      ✕ calculates capacity gaps from capacity_gaps_view
      ✕ handles empty database gracefully
    getCapacityReport - Get Capacity Report
      ✓ retrieves capacity report with date range filtering (2 ms)
      ✓ calculates capacity gaps with correct status
      ✓ transforms utilization data correctly (1 ms)
      ✓ includes project demands filtered by date range (1 ms)
      ✓ generates capacity timeline (1 ms)
    getProjectReport - Get Project Report
      ✕ retrieves projects without filters (1 ms)
      ✕ applies status and priority filtering (1 ms)
      ✕ applies projectType and location filtering
    getTimelineReport - Get Timeline Report
      ✓ retrieves timeline with date range (2 ms)
      ✓ retrieves all timeline data without date filters
    getDemandReport - Get Demand Report
      ✕ retrieves demand data with baseline scenario filtering (2 ms)
      ✕ aggregates demand by project, role, and project type (1 ms)
      ✕ generates monthly timeline correctly (1 ms)
      ✕ handles scenario_id header and branch scenarios (1 ms)
      ✕ handles includeAllScenarios flag (1 ms)
    getUtilizationReport - Get Utilization Report
      ✓ calculates utilization with date filtering (1 ms)
      ✓ categorizes allocation status correctly
      ✓ identifies over-utilized and under-utilized people (1 ms)
      ✓ calculates health summary correctly
    getGapsAnalysis - Get Gaps Analysis
      ✓ retrieves gaps from capacity_gaps_view (1 ms)
      ✓ calculates gap percentages and status correctly (1 ms)
      ✓ identifies critical role gaps
      ✓ calculates projects with unmet demands (1 ms)

  ● ReportingController › getDashboard - Get Dashboard Data › retrieves dashboard with all components

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"data": ObjectContaining {"availability": ObjectContaining {"ASSIGNED": Any<Number>, "AVAILABLE": Any<Number>}, "capacityGaps": ObjectContaining {"GAP": Any<Number>, "OK": Any<Number>, "TIGHT": Any<Number>}, "projectHealth": Any<Object>, "summary": ObjectContaining {"people": 20, "projects": 5, "roles": 8}, "utilization": Any<Object>}, "success": true}

    Number of calls: 0

      105 |       await flushPromises();
      106 |
    > 107 |       expect(mockRes.json).toHaveBeenCalledWith(
          |                            ^
      108 |         expect.objectContaining({
      109 |           success: true,
      110 |           data: expect.objectContaining({

      at Object.<anonymous> (src/server/api/controllers/__tests__/ReportingController.test.ts:107:28)

  ● ReportingController › getDashboard - Get Dashboard Data › retrieves dashboard with all components

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:8:20

  ● ReportingController › getDashboard - Get Dashboard Data › categorizes project health correctly

    TypeError: Cannot read properties of undefined (reading '0')

      162 |       await flushPromises();
      163 |
    > 164 |       const response = mockRes.json.mock.calls[0][0];
          |                                                  ^
      165 |       expect(response.data.projectHealth).toHaveProperty('ACTIVE');
      166 |       expect(response.data.projectHealth).toEqual(expect.any(Object));
      167 |     });

      at Object.<anonymous> (src/server/api/controllers/__tests__/ReportingController.test.ts:164:50)

  ● ReportingController › getDashboard - Get Dashboard Data › categorizes project health correctly

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:8:20

  ● ReportingController › getDashboard - Get Dashboard Data › calculates capacity gaps from capacity_gaps_view

    TypeError: Cannot read properties of undefined (reading '0')

      203 |       await flushPromises();
      204 |
    > 205 |       const response = mockRes.json.mock.calls[0][0];
          |                                                  ^
      206 |       expect(response.data.capacityGaps).toEqual({
      207 |         GAP: 1,    // Developer
      208 |         TIGHT: 1,  // Designer

      at Object.<anonymous> (src/server/api/controllers/__tests__/ReportingController.test.ts:205:50)

  ● ReportingController › getDashboard - Get Dashboard Data › calculates capacity gaps from capacity_gaps_view

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:8:20

  ● ReportingController › getDashboard - Get Dashboard Data › handles empty database gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"data": ObjectContaining {"summary": {"people": 0, "projects": 0, "roles": 0}}, "success": true}

    Number of calls: 0

      226 |       await flushPromises();
      227 |
    > 228 |       expect(mockRes.json).toHaveBeenCalledWith(
          |                            ^
      229 |         expect.objectContaining({
      230 |           success: true,
      231 |           data: expect.objectContaining({

      at Object.<anonymous> (src/server/api/controllers/__tests__/ReportingController.test.ts:228:28)

  ● ReportingController › getDashboard - Get Dashboard Data › handles empty database gracefully

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:8:20

  ● ReportingController › getProjectReport - Get Project Report › retrieves projects without filters

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"data": ObjectContaining {"projects": Any<Array>, "summary": ObjectContaining {"byPriority": Any<Object>, "byStatus": Any<Object>}}, "success": true}

    Number of calls: 0

      518 |       await flushPromises();
      519 |
    > 520 |       expect(mockRes.json).toHaveBeenCalledWith(
          |                            ^
      521 |         expect.objectContaining({
      522 |           success: true,
      523 |           data: expect.objectContaining({

      at Object.<anonymous> (src/server/api/controllers/__tests__/ReportingController.test.ts:520:28)

  ● ReportingController › getProjectReport - Get Project Report › retrieves projects without filters

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:271:20

  ● ReportingController › getProjectReport - Get Project Report › applies status and priority filtering

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:271:20

  ● ReportingController › getProjectReport - Get Project Report › applies projectType and location filtering

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:271:20

  ● ReportingController › getDemandReport - Get Demand Report › retrieves demand data with baseline scenario filtering

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"data": ObjectContaining {"byProject": Any<Array>, "by_project_type": Any<Array>, "by_role": Any<Array>, "demandData": Any<Array>, "summary": ObjectContaining {"roles_with_demand": Any<Number>, "total_hours": Any<Number>, "total_projects": Any<Number>}, "timeline": Any<Array>}, "success": true}

    Number of calls: 0

      744 |       await flushPromises();
      745 |
    > 746 |       expect(mockRes.json).toHaveBeenCalledWith(
          |                            ^
      747 |         expect.objectContaining({
      748 |           success: true,
      749 |           data: expect.objectContaining({

      at Object.<anonymous> (src/server/api/controllers/__tests__/ReportingController.test.ts:746:28)

  ● ReportingController › getDemandReport - Get Demand Report › retrieves demand data with baseline scenario filtering

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:387:20

  ● ReportingController › getDemandReport - Get Demand Report › aggregates demand by project, role, and project type

    TypeError: Cannot read properties of undefined (reading '0')

      792 |       await flushPromises();
      793 |
    > 794 |       const response = mockRes.json.mock.calls[0][0];
          |                                                  ^
      795 |
      796 |       expect(response.data.byProject).toHaveLength(2);
      797 |       expect(response.data.byProject[0]).toMatchObject({

      at Object.<anonymous> (src/server/api/controllers/__tests__/ReportingController.test.ts:794:50)

  ● ReportingController › getDemandReport - Get Demand Report › aggregates demand by project, role, and project type

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:387:20

  ● ReportingController › getDemandReport - Get Demand Report › generates monthly timeline correctly

    TypeError: Cannot read properties of undefined (reading '0')

      853 |       await flushPromises();
      854 |
    > 855 |       const response = mockRes.json.mock.calls[0][0];
          |                                                  ^
      856 |       expect(response.data.timeline).toHaveLength(3);
      857 |       expect(response.data.timeline[0]).toMatchObject({
      858 |         month: '2024-01',

      at Object.<anonymous> (src/server/api/controllers/__tests__/ReportingController.test.ts:855:50)

  ● ReportingController › getDemandReport - Get Demand Report › generates monthly timeline correctly

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:387:20

  ● ReportingController › getDemandReport - Get Demand Report › handles scenario_id header and branch scenarios

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:387:20

  ● ReportingController › getDemandReport - Get Demand Report › handles includeAllScenarios flag

    TypeError: Cannot read properties of undefined (reading 'error')

      21 |   protected handleError(error: any, req: RequestWithLogging, res: Response, message = 'Internal server error') {
      22 |     // Use request logger for consistent context
    > 23 |     req.logger.error('Controller error', error, {
         |                ^
      24 |       controller: this.constructor.name,
      25 |       sqlError: error.code === 'SQLITE_ERROR' ? error.message : undefined
      26 |     });

      at ReportingController.error [as handleError] (src/server/api/controllers/EnhancedBaseController.ts:23:16)
      at ReportingController.handleError [as executeQuery] (src/server/api/controllers/EnhancedBaseController.ts:87:12)
      at src/server/api/controllers/ReportingController.ts:387:20

-----------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------------------------
File                               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                      
-----------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------------------------
All files                          |   44.53 |    31.92 |   33.17 |   44.23 |                                                                                                                        
 api/controllers                   |    68.8 |    59.66 |   63.41 |   68.25 |                                                                                                                        
  EnhancedBaseController.ts        |    37.2 |    10.34 |   42.85 |    37.2 | 15-18,28-59,80,88-120,148,163-165                                                                                      
  ReportingController.ts           |   72.26 |    65.03 |   67.64 |    71.8 | 24-155,160-167,296-318,403,414,418,420,439,448,452,454,479,488,492,494,518,527,531,533,592,621-622,644-682,772-773,775 
 api/controllers/__tests__/helpers |   73.07 |       50 |   32.55 |   72.44 |                                                                                                                        
  mockDb.ts                        |   73.07 |       50 |   32.55 |   72.44 | 87,93,112,123-139,152-168,179-181,195-199,215-217,227,235,243,251,259,267,289,298,306                                  
 config                            |    7.31 |        0 |       0 |     7.5 |                                                                                                                        
  auditConfig.ts                   |    7.31 |        0 |       0 |     7.5 | 4-74,78,82-87                                                                                                          
 database                          |   20.68 |        7 |    6.38 |   20.52 |                                                                                                                        
  AuditedDatabase.ts               |    5.31 |        0 |       0 |    5.37 | 16-22,43-254,260-291                                                                                                   
  index.ts                         |    20.2 |        0 |    6.25 |    20.4 | 15-36,41-46,57-61,67-78,89-102,108-110,115-121,127-147,153-191                                                         
  knexfile.e2e.ts                  |      50 |      100 |       0 |   46.15 | 37-43                                                                                                                  
  knexfile.ts                      |      64 |    58.33 |   66.66 |      64 | 10-11,17,32,56-60                                                                                                      
 services/audit                    |    1.19 |        0 |       0 |    1.27 |                                                                                                                        
  AuditService.ts                  |    1.19 |        0 |       0 |    1.27 | 48-619                                                                                                                 
-----------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------------------------
Test Suites: 1 failed, 1 total
Tests:       12 failed, 15 passed, 27 total
Snapshots:   0 total
Time:        0.784 s
Ran all test suites matching ReportingController.test.ts.
