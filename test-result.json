🚀 Starting E2E global setup...
🗄️ Initializing E2E database...
🧪 Initializing E2E test database...
🗑️ Removed existing E2E database file
🔧 Running E2E database migrations...
Creating baseline database schema...
✅ Baseline database schema created successfully
Fixing primary role foreign key constraint...
✅ Fixed primary role foreign key constraint
Creating missing database views...
✅ Created missing database views
Adding person_utilization_view and project_demands_view...
✅ Added person_utilization_view and project_demands_view
Fixing project_demands_view with correct join conditions...
✅ Fixed project_demands_view with correct join conditions
Fixing database views...
✅ Fixed database views
Adding project_health_view for gaps analysis...
✅ Added project_health_view for gaps analysis
Fixing project_health_view with correct health_status column...
✅ Fixed project_health_view with correct health_status column
Creating settings table...
✅ Created settings table with default import settings
🔧 Fixing assignments with null dates...
Found 0 phase-based assignments with null dates
Found 0 project-based assignments with null dates
Found 0 assignments still with null dates
✅ Assignment dates fixed
Improving project_demands_view with hour calculations...
✅ Improved project_demands_view with hour calculations and project type info
Fixing project_demands_view missing columns...
✅ Fixed project_demands_view with missing phase_id and renamed estimated_hours to demand_hours
Creating project_phase_dependencies table...
✅ Created project_phase_dependencies table with constraints and indexes
🔧 Fixing missing IDs in database records...
Found 0 assignments without IDs
Found 0 availability overrides without IDs
✅ Fixed missing IDs
Creating person_availability_view...
✅ Created person_availability_view
Fixing person_utilization_view to use scenario assignments...
✅ Fixed person_utilization_view to use scenario assignments
Fixing project_demands_view to use actual assignments...
✅ Fixed project_demands_view to use scenario assignments
🌱 Seeding E2E test data...
🌱 Seeding consolidated E2E test data...
Existing people before clear: 
People count after clear: 0
✅ Consolidated E2E test data seeded successfully
📊 Utilization scenarios created:
   - E2E Over Utilized: 120% (80% + 40%)
   - E2E Normal Utilized: 80%
   - E2E Under Utilized: 40%
   - E2E Zero Utilized: 0%
✅ E2E database initialized successfully
✅ E2E database initialized successfully
ℹ️ Development server already running on ports 3110/3120
   E2E tests will use the existing server and database.
   For isolated testing, stop the dev server first.
⏳ Waiting for application to be ready...
✅ Application is ready
🔍 Verifying test data...
✅ API health check passed
✅ /api/roles: 13 items
🔍 Handling initial profile selection...
📋 Profile selection modal detected
🎯 Starting profile selection...

📍 Attempt 1/3 to select profile...
Select trigger text: "Select your name..."
📂 Opening profile dropdown...
🔍 Trying strategy: Standard role="option"
✅ Standard role="option": Found 8 options
DOM state: 0 portals, 0 popper wrappers
Available profiles: []
Selecting profile: "undefined"
❌ Attempt 1 failed: locator.click: Timeout 30000ms exceeded.
Call log:
[2m  - waiting for locator('[role="option"]:visible').first()[22m

    at selectProfile (/home/tony/GitHub/Capacinator/tests/e2e/helpers/e2e-global-setup.ts:471:43)
    at handleInitialProfileSelection (/home/tony/GitHub/Capacinator/tests/e2e/helpers/e2e-global-setup.ts:342:7)
    at globalSetup (/home/tony/GitHub/Capacinator/tests/e2e/helpers/e2e-global-setup.ts:78:5) {
  name: 'TimeoutError'
}
🔄 Retrying...

📍 Attempt 2/3 to select profile...
Select trigger text: "Select your name..."
📂 Opening profile dropdown...
🔍 Trying strategy: Standard role="option"
⚠️ Standard role="option": No visible options
🔍 Trying strategy: Radix collection items
⚠️ Radix collection items: No visible options
🔍 Trying strategy: Portal with role="option"
⚠️ Portal with role="option": No visible options
🔍 Trying strategy: Any SelectItem in portal
⚠️ Any SelectItem in portal: No visible options
🔍 Trying strategy: Direct SelectContent children
⚠️ Direct SelectContent children: No visible options
🎹 Trying keyboard navigation...
📊 After keyboard activation: 0 options
DOM state: 0 portals, 0 popper wrappers
❌ Attempt 2 failed: Error: No profile options found on attempt 2
    at selectProfile (file:///home/tony/GitHub/Capacinator/tests/e2e/helpers/e2e-global-setup.ts:516:15)
    at handleInitialProfileSelection (file:///home/tony/GitHub/Capacinator/tests/e2e/helpers/e2e-global-setup.ts:342:7)
    at globalSetup (file:///home/tony/GitHub/Capacinator/tests/e2e/helpers/e2e-global-setup.ts:78:5)
    at Object.setup (/home/tony/GitHub/Capacinator/node_modules/playwright/lib/runner/tasks.js:173:27)
    at taskLoop (/home/tony/GitHub/Capacinator/node_modules/playwright/lib/runner/taskRunner.js:62:11)
    at TaskRunner.runDeferCleanup (/home/tony/GitHub/Capacinator/node_modules/playwright/lib/runner/taskRunner.js:78:5)
    at TaskRunner.run (/home/tony/GitHub/Capacinator/node_modules/playwright/lib/runner/taskRunner.js:42:33)
    at runTasks (/home/tony/GitHub/Capacinator/node_modules/playwright/lib/runner/tasks.js:79:18)
    at runAllTestsWithConfig (/home/tony/GitHub/Capacinator/node_modules/playwright/lib/runner/testRunner.js:392:18)
    at runTests (/home/tony/GitHub/Capacinator/node_modules/playwright/lib/program.js:188:18)
    at i.<anonymous> (/home/tony/GitHub/Capacinator/node_modules/playwright/lib/program.js:64:7)
🔄 Retrying...

📍 Attempt 3/3 to select profile...
Select trigger text: "Select your name..."
📂 Opening profile dropdown...
🔍 Trying strategy: Standard role="option"
✅ Standard role="option": Found 8 options
DOM state: 0 portals, 0 popper wrappers
Available profiles: []
Selecting profile: "undefined"
❌ Attempt 3 failed: locator.click: Timeout 30000ms exceeded.
Call log:
[2m  - waiting for locator('[role="option"]:visible').first()[22m

    at selectProfile (/home/tony/GitHub/Capacinator/tests/e2e/helpers/e2e-global-setup.ts:471:43)
    at handleInitialProfileSelection (/home/tony/GitHub/Capacinator/tests/e2e/helpers/e2e-global-setup.ts:342:7)
    at globalSetup (/home/tony/GitHub/Capacinator/tests/e2e/helpers/e2e-global-setup.ts:78:5) {
  name: 'TimeoutError'
}
🔌 All UI attempts failed, trying API fallback...
🔌 Using API fallback for profile selection...
API fallback: Selecting Alice Johnson
✅ Profile selected via API fallback
✅ Profile selected and saved
💾 Current auth data: { hasCurrentUser: true, hasSelectedProfile: true }
💾 Authentication state saved to /home/tony/GitHub/Capacinator/test-results/e2e-auth.json
✅ Saved state verification: Contains localStorage data
✅ E2E global setup completed successfully
